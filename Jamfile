#
# Jam build system for Euphoria
#

SubDir TOP ;

#
# Configuration
#
# Use: jam DEBUG=yes config to create/update config.jam
#

CONFIG  ?= [ FDirName $(TOP) config.jam ] ;
if $(UNIX) {
    MANAGED_MEMORY_DEFAULT = off ;
} else {
    MANAGED_MEMORY_DEFAULT = on ;
}

rule WriteConfig
{
    # Must quote filenames such as C:\Euphoria otherwise when reading them
    # back from the config file, \E will be interpreted as a special character
    # like \n.

    BUILD_DIR on $(<) = $(BUILD_DIR:Q) ;

    # Let the user see all the options as they may have simply changed one
    # value and left the others alone.

    #Echo "" ;
    #Echo "Configuration settings:" ;
    #Echo "" ;
    #Echo "   BUILD_DIR=$(BUILD_DIR)" ;
    #Echo "   DEBUG=$(DEBUG)" ;
    #Echo "   MANAGED_MEMORY=$(MANAGED_MEMORY)" ;
    #Echo "" ;
}

actions WriteConfig
{
    echo # Jam configuration file for Euphoria > $(CONFIG)
    echo BUILD_DIR ?= $(BUILD_DIR) ; >> $(CONFIG)
    echo DEBUG ?= $(DEBUG) ; >> $(CONFIG)
    echo MANAGED_MEMORY ?= $(MANAGED_MEMORY) ; >> $(CONFIG)
    
    echo =======================================
    echo Configuration Updated
    echo ---------------------
    echo   BUILD_DIR      : $(BUILD_DIR)
    echo   DEBUG          : $(DEBUG)
    echo   MANAGED_MEMORY : $(MANAGED_MEMORY)
    echo =======================================
    
    Exit ;
}

if [ FileExists $(CONFIG) ]
{
    include $(CONFIG) ;

	WriteConfig config ;
	
	#
	# Include our sub directory projects
	#

	SubInclude TOP source ;
	SubInclude TOP demo ;
	SubInclude TOP docs ;
	SubInclude TOP tests ;

}
else
{
    Echo "ERROR: $(CONFIG) does not yet exist" ;
    Echo "" ;
    Echo "To create the $(CONFIG) file, use jam VARNAME=VALUE config" ;
    Echo "" ;
    Echo "Valid options are:" ;
    Echo "" ;
    Echo "  DEBUG=on|off       Enable/Disable debug mode (default: off)" ;
    Echo "  MANAGED_MEM=on|off Enable/Disable managed memory " ;
    Echo "                     (default: $(MANAGED_MEMORY_DEFAULT))" ;
    Echo "  BUILD_DIR=dir      Directory to build Euphoria and related " ;
    Echo "                     tools in (default: build)" ;
    Echo "" ;
    Echo "To create a default configuration file, simply run the command:" ;
    Echo "" ;
    Echo "  jam config" ;
    Echo "" ;
    Echo "Values can be changed at any time. Changing one value will not" ;
    Echo "affect other values. For instance, if you have a custom build" ;
    Echo "directory you can use jam DEBUG=on config and jam DEBUG=off config" ;
    Echo "to toggle the debug setting without affecting the previously set" ;
    Echo "custom build directory." ;
    Echo "" ;

	#
	# Setup our defaults. Anything the user supplies on the command line will
	# override these settings
	#
	
	DEBUG           ?= no ;
	MANAGED_MEMORY  ?= $(MANAGED_MEMORY_DEFAULT) ;
	BUILD_DIR       ?= [ FDirName $(TOP) build ] ;

    WriteConfig config ;
}
