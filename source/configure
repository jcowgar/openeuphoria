#!/bin/sh

UNAME_SYSTEM=`(uname -s) 2>/dev/null`  || UNAME_SYSTEM=unknown
if echo "$UNAME_SYSTEM" | grep CYGWIN; then
	# for now, we build with -mno-cygwin under cygwin, so this is treated
	# identically to MinGW
	# A true exu.exe should probably set UNAME_SYSTEM="CYGWIN"
	UNAME_SYSTEM=WINDOWS
elif echo "$UNAME_SYSTEM" | grep MINGW; then
	UNAME_SYSTEM=WINDOWS
fi

if [ -e source/global.e ]; then
	PREFIX=source/
else
	PREFIX=./
fi

if [ `grep -e "EBSD.*TRUE" "$PREFIX"common.e` ]; then
	ECONFIG=BSD
else
	ECONFIG=LINUX
fi

if test $UNAME_SYSTEM = "Linux"; then
	echo EU_VERSION=`grep -e INTERPRETER_VERSION "$PREFIX"global.e | sed -re "s/^[^0-9\.]*([0-9\.]+)[^0-9\.]*$/\1/"` > "$PREFIX"Makefile.eu
	echo EBSD= >> "$PREFIX"Makefile.eu
	echo EOSX= >> "$PREFIX"Makefile.eu
	echo ELINUX=1 >> "$PREFIX"Makefile.eu
	echo EMINGW= >> "$PREFIX"Makefile.eu
	echo EDJGPP= >> "$PREFIX"Makefile.eu
elif test $UNAME_SYSTEM = "MS-DOS"; then
	echo EU_VERSION=`grep -e INTERPRETER_VERSION "$PREFIX"global.e | sed -re "s/^[^0-9\.]*([0-9\.]+)[^0-9\.]*$/\1/"` > "$PREFIX"Makefile.eu
	echo EBSD= >> "$PREFIX"Makefile.eu
	echo EOSX= >> "$PREFIX"Makefile.eu
	echo ELINUX= >> "$PREFIX"Makefile.eu
	echo EMINGW= >> "$PREFIX"Makefile.eu
	echo EDJGPP=1 >> "$PREFIX"Makefile.eu
elif test $UNAME_SYSTEM = "WINDOWS"; then
	echo EU_VERSION=`grep -e INTERPRETER_VERSION "$PREFIX"global.e | sed -re "s/^[^0-9\.]*([0-9\.]+)[^0-9\.]*$/\1/"` > "$PREFIX"Makefile.eu
	echo EBSD= >> "$PREFIX"Makefile.eu
	echo EOSX= >> "$PREFIX"Makefile.eu
	echo ELINUX= >> "$PREFIX"Makefile.eu
	echo EMINGW=1 >> "$PREFIX"Makefile.eu
	echo EDJGPP= >> "$PREFIX"Makefile.eu
else
	echo EU_VERSION=`grep -e INTERPRETER_VERSION "$PREFIX"global.e | sed -Ee "s/^[^0-9\.]*([0-9\.]+)[^0-9\.]*$/\1/"` > "$PREFIX"Makefile.eu
	echo EBSD=1 >> "$PREFIX"Makefile.eu
	if test $UNAME_SYSTEM = "Darwin"; then
		echo EOSX=1 >> "$PREFIX"Makefile.eu
	else
		echo EOSX= >> "$PREFIX"Makefile.eu
	fi
	echo ELINUX= >> "$PREFIX"Makefile.eu
	echo EMINGW= >> "$PREFIX"Makefile.eu
	echo EDJGPP= >> "$PREFIX"Makefile.eu
fi

case "${UNAME_SYSTEM}:${ECONFIG}" in
	Linux:BSD)
		echo Linux:BSD
		sed -ri -e "s/EBSD = TRUE/EBSD = FALSE/" "$PREFIX"common.e
		sed -ri -e "s/EOSX = TRUE/EOSX = FALSE/" "$PREFIX"common.e
		;;
	*BSD:LINUX)
		echo BSD:Linux
		sed -Ei .bsd -e "s/EBSD = FALSE/EBSD = TRUE/" "$PREFIX"common.e
		;;
	Darwin:LINUX)
		echo Darwin:Linux
		sed -Ei .bsd -e "s/EBSD = FALSE/EBSD = TRUE/" "$PREFIX"common.e
		sed -Ei .osx -e "s/EOSX = FALSE/EOSX = TRUE/" "$PREFIX"common.e
		;;
	*)
		# do nothing
		;;
esac

# parameters
while [ "$1" != "" ]; do
    case $1 in
        --with-eu3 )   
                       echo EU3=1 >> "$PREFIX"Makefile.eu
                       echo PWD=`pwd` >> "$PREFIX"Makefile.eu
        ;;
        --full )
                       echo RELEASE=1 >> "$PREFIX"Makefile.eu
        ;;
        --managed-mem )
		       # currently this is Windows only
                       echo MANAGED_MEM=1 >> "$PREFIX"Makefile.eu
        ;;
        --debug )
                       echo EDEBUG=1 >> "$PREFIX"Makefile.eu
        ;;
    esac
    shift
done
